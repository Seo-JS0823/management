<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.emp.manager.employee.ManagerLeaveMapper">
	
	<!-- 당월 연차 정보 업데이트 -->
	<insert id="annualCreate">
		INSERT INTO annualleave (employee_id, year, over_leave_cnt, use_leave_cnt, leave_flag)
		SELECT
		   E.employee_id,
		   TO_DATE(#{year_month}, 'YYYY-MM-DD') AS year,
		   CASE
		      WHEN COUNT(A.atte_flag) = D.month_days THEN 1
		      ELSE 0
		   END AS over_leave_cnt,
		   0 AS use_leave_cnt,
		   1 AS leave_flag
		FROM
		   employees E LEFT JOIN attendance_record A
		ON
		   A.employee_id = E.employee_id AND
		   TO_CHAR(A.currentDate, 'YYYY-MM') = SUBSTR(#{year_month}, 1, 7) AND
		   (A.atte_flag = 1 OR A.atte_flag = 5)
		CROSS JOIN (
		   SELECT
		      COUNT(*) AS month_days
		   FROM (
		      SELECT
		         TO_DATE(#{year_month}, 'YYYY-MM-DD') + LEVEL -1 AS DT
		      FROM
		         dual
		      CONNECT BY LEVEL <![CDATA[<=]]> LAST_DAY(TO_DATE(#{year_month}, 'YYYY-MM-DD')) - TO_DATE(#{year_month}, 'YYYY-MM-DD') + 1
		   )
		   WHERE TO_CHAR(DT,'D') NOT IN ('1', '7')
		) D
		GROUP BY E.employee_id, D.month_days
	</insert>
	
	<!-- 당월 연차 정보 업데이트 되었는지 확인 -->
	<select id="annualContains" resultType="int">
		SELECT
			COUNT(*) AS cnt
		FROM
			annualleave
		WHERE
			TO_DATE(TO_CHAR(year, 'YYYY-MM'), 'YYYY-MM') = TO_DATE(#{year_month}, 'YYYY-MM') AND
			leave_flag = 1  
	</select>
		
</mapper>